<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | AegisAI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: #f4f6f9;
            font-family: 'Segoe UI', sans-serif;
        }

        .sidebar {
            height: 100vh;
            width: 250px;
            position: fixed;
            background: #0f2942;
            color: white;
            padding-top: 20px;
            z-index: 1000;
        }

        .nav-link {
            color: #b0c4d6;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: 0.3s;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(30, 144, 255, 0.1);
            color: #1e90ff;
            border-left: 4px solid #1e90ff;
        }

        .main-content {
            margin-left: 250px;
            padding: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .scan-section {
            background: #0f2942;
            border-radius: 12px;
            padding: 30px;
            color: white;
            margin: 30px 0;
        }

        .btn-scan {
            background: #1e90ff;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 5px;
            font-weight: bold;
        }

        .btn-scan:hover {
            background: #1565c0;
        }

        /* New Result Styling */
        .result-panel {
            display: none;
            margin-top: 20px;
        }

        .layer-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .score-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 8px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            margin: 0 auto;
            color: white;
        }

        .score-safe {
            border-color: #28a745;
            color: #28a745;
        }

        .score-warn {
            border-color: #ffc107;
            color: #ffc107;
        }

        .score-danger {
            border-color: #dc3545;
            color: #dc3545;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <h3 class="px-4 mb-4"><i class="fas fa-shield-alt"></i> AegisAI</h3>
        <a href="/dashboard" class="nav-link active"><i class="fas fa-th-large me-2"></i> Dashboard</a>
        <a href="/scans" class="nav-link"><i class="fas fa-search me-2"></i> Scans</a>
        <a href="/reports" class="nav-link"><i class="fas fa-file-alt me-2"></i> Reports</a>
        <a href="/settings" class="nav-link"><i class="fas fa-cog me-2"></i> Settings</a>
        <a href="/account" class="nav-link"><i class="fas fa-user me-2"></i> Account</a>
    </div>

    <div class="main-content">

        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <h5>Total Threats</h5>
                    <h2 id="val-threats">...</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h5>URLs Scanned</h5>
                    <h2 id="val-scanned">...</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h5>Blocked</h5>
                    <h2 id="val-blocked">...</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h5>Health</h5>
                    <h2 id="val-health">...</h2>
                </div>
            </div>
        </div>

        <div class="scan-section">
            <h4 class="mb-3">Advanced Threat Detection</h4>
            <div class="d-flex gap-2">
                <input type="text" id="urlInput" class="form-control"
                    placeholder="Enter URL to analyze (e.g., http://suspicious-site.com)...">
                <button class="btn-scan" onclick="performScan()">Analyze</button>
            </div>

            <div id="resultPanel" class="result-panel">
                <div class="row mt-4">

                    <div class="col-md-4 text-center border-end border-secondary">
                        <h5 class="text-white-50">RISK SCORE</h5>
                        <div id="riskCircle" class="score-circle mt-3">0%</div>
                        <h3 id="riskText" class="mt-3 text-white">Safe</h3>

                        <div class="mt-4 text-start bg-dark p-3 rounded">
                            <small class="text-muted">RECOMMENDATION</small>
                            <div id="recText" class="fw-bold text-white">---</div>
                        </div>
                        <div class="mt-2 text-start bg-dark p-3 rounded">
                            <small class="text-muted">REASON</small>
                            <div id="reasonText" class="text-white small">---</div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <h5 class="text-white-50 mb-3">6-LAYER SECURITY BREAKDOWN</h5>
                        <div class="row" id="layersGrid">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stat-card mt-4">
            <h5>Live Threat Traffic</h5>
            <div style="height: 200px;"><canvas id="mainChart"></canvas></div>
        </div>
    </div>

    <script>
        // 1. Load Stats
        function loadStats() {
            fetch('/api/stats').then(r => r.json()).then(d => {
                document.getElementById('val-threats').innerText = d.stats.threats_detected;
                document.getElementById('val-scanned').innerText = d.stats.urls_scanned;
                document.getElementById('val-blocked').innerText = d.stats.malicious_blocked;
                document.getElementById('val-health').innerText = d.stats.system_health + "%";
                initChart(d.chart_data);
            });
        }

        // 2. Scan Logic
        function performScan() {
            const url = document.getElementById('urlInput').value;
            const panel = document.getElementById('resultPanel');
            const btn = document.querySelector('.btn-scan');

            if (!url) return alert("Enter URL");

            btn.innerText = "Analyzing..."; btn.disabled = true; panel.style.display = "none";

            fetch('/api/scan', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: url })
            })
                .then(r => r.json())
                .then(data => {
                    btn.innerText = "Analyze"; btn.disabled = false; panel.style.display = "block";

                    // Update Risk Score
                    const circle = document.getElementById('riskCircle');
                    circle.innerText = data.risk_score + "%";
                    circle.className = "score-circle " + (data.risk_score > 75 ? "score-danger" : (data.risk_score > 40 ? "score-warn" : "score-safe"));

                    document.getElementById('riskText').innerText = data.status.toUpperCase();
                    document.getElementById('riskText').className = "mt-3 fw-bold " + (data.risk_score > 75 ? "text-danger" : "text-white");

                    document.getElementById('recText').innerText = data.recommendation;
                    document.getElementById('reasonText').innerText = data.reason;

                    // Generate 6 Layers Grid
                    const grid = document.getElementById('layersGrid');
                    grid.innerHTML = "";
                    data.layers.forEach(layer => {
                        const color = layer.status === "Safe" || layer.status === "Clean" ? "text-success" : "text-danger";
                        grid.innerHTML += `
                    <div class="col-md-4">
                        <div class="layer-card">
                            <small class="text-white-50">${layer.name}</small>
                            <div class="fw-bold mt-1 ${color}">${layer.val}</div>
                        </div>
                    </div>`;
                    });
                    loadStats(); // Refresh counters
                });
        }

        // 3. Simple Chart
        function initChart(data) {
            Chart.getChart("mainChart")?.destroy();
            new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: { labels: [1, 2, 3, 4, 5, 6], datasets: [{ label: 'Threats', data: data.threats, borderColor: '#1e90ff', fill: true }] },
                options: { plugins: { legend: false }, maintainAspectRatio: false }
            });
        }

        document.addEventListener("DOMContentLoaded", loadStats);
    </script>
</body>

</html>